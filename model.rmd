---
title: "R Notebook"
author: shawshank
date: 4/20/20
output: html_document
---
```{r}
library(bnlearn)
library(Rgraphviz)
`:=` <- `<-`
# install.packages("magrittr") # package installations are only needed the first time you use it
# install.packages("dplyr")    # alternative installation of the %>%
# library(magrittr) # needs to be run every time you start R and want to use %>%
# library(dplyr)    # alternatively, this also loads %>%
df <- read.csv("data/data_with_cordinates.csv")
df$BPB = as.factor(as.character(df$BPB))

nrow(df)
# sapply(df, class)
```

```{r}
colnames(df)
```



```{r}
dag <- model2network("[Neigh][Type][BPB|Type][Zest|BPB:Neigh:Type][Rent|BPB:Neigh][ROI|Zest:Rent]")
dag2 <- model2network("[latitude][longitude][Type][BPB|Type][Zest|BPB:latitude:longitude:Type][Rent|BPB:latitude:longitude][ROI|Zest:Rent]")

graphviz.plot(dag2)
```

```{r}
lm(longitude~latitude, df)
plot(df$latitude, df$longitude)
abline(-83.87, -1.02)


```



```{r}
fit = bn.fit(dag2, df[,nodes(dag2)])
fit

```

```{r}
nodes(dag2)
```


```{r}
d_sep <- bnlearn:::dseparation
vars <- nodes(dag2)
pairs <- combn(x = vars, 2, list)
arg_sets <- list()

for(pair in pairs){
  others <- setdiff(vars, pair)
  conditioning_sets <- unlist(lapply(0:4, function(.x) combn(others, .x, list)), recursive = F)
  for(set in conditioning_sets){
    args <- list(x = pair[1], y = pair[2], z = set)
    arg_sets <- c(arg_sets, list(args))
  }
}


d_sep_list <- list()
for(arg in arg_sets){
  if(d_sep(bn=dag2, x=arg$x, y=arg$y, z=arg$z)){
    args <- list(x = arg$x, y = arg$y, z = arg$z)
    d_sep_list <- c(d_sep_list, list(args))
  }

}
#cat(toString(d_sep_list[[10]]$x), " is d-seperated from ", toString(d_sep_list[[10]]$y), " by ", toString(d_sep_list[[10]]$z))
length(d_sep_list)
```


```{r}
failures <- 0
for(arg in d_sep_list){
  test_outcome <- ci.test(arg$x, arg$y, arg$z, df)
  alpha <- .05
  if(test_outcome$p.value < alpha){
    failures <- failures + 1
    print(test_outcome)
  }
}
print(failures)

```



