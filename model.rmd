---
title: "R Notebook"
author: shawshank
date: 4/20/20
output: html_document
---
```{r}
library(bnlearn)
library(Rgraphviz)
`:=` <- `<-`
# install.packages("magrittr") # package installations are only needed the first time you use it
# install.packages("dplyr")    # alternative installation of the %>%
# library(magrittr) # needs to be run every time you start R and want to use %>%
# library(dplyr)    # alternatively, this also loads %>%
df <- read.csv("data/cleansed_data.csv")
df$BPB = as.factor(as.character(df$BPB))
df$Beds = as.factor(as.character(df$Beds))
df$Baths = as.factor(as.character(df$Baths))
nrow(df)
df
# sapply(df, class)
```



```{r}
dag1 <- model2network("[Neigh][Type][BPB|Type][Zest|BPB:Neigh:Type][Rent|BPB:Neigh][ROI|Zest:Rent]")
dag2 <- model2network("[latitude][longitude][Type][BPB|Type][Zest|BPB:latitude:longitude:Type][Rent|BPB:latitude:longitude][ROI|Zest:Rent]")
graphviz.plot(dag1)
graphviz.plot(dag2)
```

```{r}
lm(longitude~latitude, df)
plot(df$latitude, df$longitude)
abline(-83.87, -1.02)


```



```{r}
fit_model_1 = bn.fit(dag1, df[,nodes(dag1)])
fit_model_2 = bn.fit(dag2, df[,nodes(dag2)])
fit_model_2


```



```{r}
d_sep <- bnlearn:::dseparation
get_subsets <- function(model){
    vars <- nodes(model)
    pairs <- combn(x = vars, 2, list)
    arg_sets <- list()

    for(pair in pairs){
      others <- setdiff(vars, pair)
      conditioning_sets <- unlist(lapply(0:4, function(.x) combn(others, .x, list)), recursive = F)
      for(set in conditioning_sets){
        args <- list(x = pair[1], y = pair[2], z = set)
        arg_sets <- c(arg_sets, list(args))
      }
    }
      return(arg_sets)
}

dag1_subsets = get_subsets(dag1)
dag2_subsets = get_subsets(dag2)
length(dag1_subsets)
length(dag2_subsets)
```

```{r}

get_d_sep_statments <- function (model, subsets){
d_sep_list <- list()
for(arg in subsets){
  if(d_sep(bn=model, x=arg$x, y=arg$y, z=arg$z)){
    args <- list(x = arg$x, y = arg$y, z = arg$z)
    d_sep_list <- c(d_sep_list, list(args))
  }

}
  return(d_sep_list)
}

dag1_dsep_list = get_d_sep_statments(dag1, dag1_subsets)
dag2_dsep_list = get_d_sep_statments(dag2, dag2_subsets)
length(dag1_dsep_list)
length(dag2_dsep_list)
```


```{r}
failures <- 0
for(arg in dag2_dsep_list){
  test_outcome <- ci.test(arg$x, arg$y, arg$z, df[,nodes(dag2)])
  alpha <- .05
  if(test_outcome$p.value < alpha){

    failures <- failures + 1
    #print(test_outcome)
  }
}
print(failures)

```
```{r}
get_CI_sets = function(subsets, data){
ci_sets = list()
for(arg in subsets){
test_outcome <- ci.test(arg$x, arg$y, arg$z, data)
alpha <- .05
if(test_outcome$p.value > alpha){
args <- list(x = arg$x, y = arg$y, z = arg$z)
ci_sets <- c(ci_sets, list(args))
}
}
return(ci_sets)
}
dag1_ci_sets = get_CI_sets(dag1_subsets, df[,nodes(dag1)])
dag2_ci_sets = get_CI_sets(dag2_subsets, df[,nodes(dag2)])
length(dag1_ci_sets)
length(dag2_ci_sets)
```
```{r}
eval_GM_and_F <- function (d_sep_list, ci_sets){
    count <- 0
    for(d in d_sep_list){
      for(c in ci_sets){

        if (isTRUE(all.equal(d,c))){
          count <- count + 1
          break
        }

      }
    }
    return(c(count/length(d_sep_list), count/length(ci_sets)))
}
dag1_GM = eval_GM_and_F(dag1_dsep_list, dag1_ci_sets)
dag1_GM
dag2_GM = eval_GM_and_F(dag2_dsep_list, dag2_ci_sets)
dag2_GM
```



